#!/bin/sh
# See COVID-19 statistics for the world, a country, or state/territory

basedir="$HOME/.local/share/corona"

[ -z $1 ] && country="World" || country="$1"
[ -z $2 ] || state="$2"

mkdir -p $basedir || exit

([ "$state" = "sync" ] || [ ! -f $basedir/$country ]) && curl -s https://corona-stats.online/$country > $basedir/$country

[ "$state" = "sync" ] && exit

[ $country = "ls" ] &&  sed -r 's/║//g;s/\s*//g;s/│/|/g;s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g' ~/.local/share/corona/World | awk -F '|' '{print $2}' | sed '/^\s*$/d;s/\*//' | sort | uniq && exit


([ ! -f $basedir/$country ] || [ "$(stat -c "%y" $basedir/$country 2>/dev/null | cut -d ' ' -f1)" != "$(date '+%Y-%m-%d')" ]) &&
	curl -s https://corona-stats.online/$country > $basedir/$country

[ ! -z $state ] && [ $(stat -c "%y" $basedir/$country 2>/dev/null | cut -d ' ' -f1) != $(date '+%Y-%m-%d') ] &&
	curl -s https://corona-stats.online/$country > $basedir/$country

[ -z $state ] && file=$basedir/World || file=$basedir/$country

[ -z $state ] && grep_query="$country" || grep_query="$state"


stats="$(grep "$grep_query" $file | sed -r 's/║//g;s/\s*//g;s/│/|/g;s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g')"


total="$(echo $stats | awk -F '|' '{print $3}')"
[ -z $total ] && echo "No data found for this country!" 3>&1 1>&2 2>&3 3>&1 && exit -1
recovered="$(echo $stats | awk -F '|' '{print $4}')"
deaths="$(echo $stats | awk -F '|' '{print $5}')"
active="$(echo $stats | awk -F '|' '{print $6}')"

echo "--- $grep_query COVID-19 Statistics ---"
echo "ACTIVE CASES: $active"
echo "RECOVERED: $recovered"
echo "DEATHS: $deaths"
echo "TOTAL CASES: $total"
