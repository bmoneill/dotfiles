#!/bin/sh
# archive: Backup files to remote server
# usage: archive <config_file>
# Configuration file should be formatted like so:
#  - First line: SSH Key path
#  - Second line: Destination
#  - The rest of the file should contain newline-separated paths to archive
# Intended to be used with a Systemd timer.
# Will not archive files if they haven't been modified in the last day.


DEFAULT_CONFIG_PATH="$HOME/.config/archive.conf"

usage() {
    echo "Usage: archive <config_file>"
    exit 1
}

CONFIG_PATH="$1"
[ -z "$CONFIG_PATH" ] && CONFIG_PATH="$DEFAULT_CONFIG_PATH"

SSH_KEY_PATH=$(head -n 1 "$CONFIG_PATH")
DESTINATION=$(head -n 2 "$CONFIG_PATH" | tail -n 1)
PATHS=$(tail -n +3 "$CONFIG_PATH")

for path in $PATHS; do
    if [ -z "$(find "$path" -mtime -1)" ]; then
	echo "Not modified in the last day."
	exit
    fi

    formatted_path="$(basename "$path" | tr ' ' '_')"
    date="$(date -u +"%Y%m%dT%H%M%SZ")"
    output="/tmp/$formatted_path-$date.tar.gz"

    tar -czf "$output" "$path"

    scp -O -i $SSH_KEY_PATH -r "$output" "$DESTINATION" || (echo "Failed to archive $path" && exit 1)
    rm -f "$output"
done
