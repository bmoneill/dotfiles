#!/bin/sh

delim="|"
. ~/.config/statusbar.conf

batstat() { \
	[ ! -d /sys/class/power_supply/BAT0 ] && exit
	echo "BAT: $(cat "/sys/class/power_supply/BAT0/capacity")%"
	[ "$(cat "/sys/class/power_supply/BAT0/status")" = "Charging" ] && echo "(+)"
}

mailstat() { \
	echo "MAIL:"
	du -a ~/.local/share/mail/*/INBOX/new/* 2>/dev/null | wc -l
}

mpdstat() { \
	mpc status | grep "playing" >/dev/null && echo "MPD: Playing" || echo "MPD: Paused"
}

ramstat() { \
	echo "RAM:"
	echo "$(echo "scale = 4\n100 - ($(grep "MemAvailable" /proc/meminfo | awk '{print $2}')" \
		"/" \
		"$(grep "MemTotal" /proc/meminfo | awk '{print $2}') * 100)" | bc | sed 's/00//')%"
}

rssstat() { \
	echo "RSS: $(newsboat -x print-unread | awk '{OFS=" ";print $1}')"
}

sndstat() { \
	echo "SND:"
	vol=$(pulsemixer --get-volume | awk '{OFS=" "; print $1}')
	[ $vol = 0 ] && echo "(M)" && return
	[ "$(pulsemixer --get-mute)" = "1" ] && echo "(M)" && return || echo "$vol%"
}

timestat() { \
	echo -n "TIME:"
	date '+ %H:%M'
}

weatherstat() { \
	echo "WEATHER:"
	sed '16q;d' "$HOME/.local/share/weather" | grep -wo "[0-9]*%" | sort -n | sed -e '$!d' | sed -e "s/^/P: /g" | tr -d '\n' | sed 's/%/%, /'
	sed '13q;d' "$HOME/.local/share/weather" | grep -o "m\\(-\\)*[0-9]\\+" | sort -n -t 'm' -k 2n | sed -e 1b -e '$!d' | tr '\n|m' ' ' | awk '{print "L: ",$1 "°, ","H:",$2 "°"}'
}

wifistat() { \
	[ ! -f /proc/net/wireless ] && return
	echo "WIFI:"
	grep "^\s*w" /proc/net/wireless | awk '{ print int($3 * 100 / 70) "%" }'
}

status() { \
	for c in $COMPONENTS; do
		echo "$delim"
		case $c in
			"BAT")  echo $(batstat) ;;
			"MAIL") echo $(mailstat) ;;
			"MPD")  echo $(mpdstat) ;;
			"RAM")  echo $(ramstat) ;;
			"RSS")  echo $(rssstat) ;;
			"SND")  echo $(sndstat) ;;
			"TIME") echo $(timestat) ;;
			"WEATHER") echo $(weatherstat) ;;
			"WIFI") echo $(wifistat) ;;
		esac
	done
}

status
